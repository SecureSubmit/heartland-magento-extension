<?php 
    $_code=$this->getMethodCode();
    $_model = Mage::getModel('hps_securesubmit/payment');
    $public_key = $_model->getConfigData('publicapikey');
?>
<fieldset class="form-list">
<ul id="payment_form_<?php echo $_code ?>" style="display:none">  
    <li>  
        <div class="input-box">  
            <label for="<?php echo $_code ?>_cc_number"><?php echo $this->__('Credit Card Number') ?> <span class="required">*</span></label><br>  
            <input type="text" id="<?php echo $_code ?>_cc_number" title="<?php echo $this->__('Credit Card Number') ?>" class="input-text validate-cc-number validate-cc-type" value="">  
            <input type="hidden" id="<?php echo $_code ?>_token" name="payment[securesubmit_token]" value="">
        </div>  
    </li>  
    <li>  
        <div class="input-box">  
            <label for="<?php echo $_code ?>_expiration"><?php echo $this->__('Expiration Date') ?> <span class="required">*</span></label><br>  
            <div class="v-fix">  
            <select id="<?php echo $_code ?>_expiration" class="month required-entry validate-cc-exp">  
            <?php $_ccExpMonth = $this->getInfoData('cc_exp_month') ?>  
            <?php foreach ($this->getCcMonths() as $k=>$v): ?>  
                <option value="<?php echo $k?$k:'' ?>" <?php if($k==$_ccExpMonth): ?> selected="selected"<?php endif ?>><?php echo $v ?></option>  
            <?php endforeach ?>  
            </select>  
            </div>  
            <div class="v-fix">  
            <?php $_ccExpYear = $this->getInfoData('cc_exp_year') ?>  
            <select id="<?php echo $_code ?>_expiration_yr" class="year required-entry">  
            <?php foreach ($this->getCcYears() as $k=>$v): ?>  
                <option value="<?php echo $k?$k:'' ?>" <?php if($k==$_ccExpYear):?> selected="selected"<?php endif ?>><?php echo $v ?></option>  
            <?php endforeach ?>  
            </select>  
            </div>  
        </div>  
    </li>  
    <li>  
        <div class="input-box">  
            <label for="<?php echo $_code ?>_cc_cid"><?php echo $this->__('Card Verification Number') ?> <span class="required">*</span></label><br>  
            <div class="v-fix"><input type="text" title="<?php echo $this->__('Card Verification Number') ?>" class="cvv required-entry input-text validate-cc-cvn" id="<?php echo $_code ?>_cc_cid" value=""></div>  

            <a href="#" class="cvv-what-is-this"><?php echo $this->__('What is this?') ?></a>  
        </div>  
    </li>  
</ul>
</fieldset>

<script type="text/javascript">
//<![CDATA[
function secureResponseHandler(response) {
    if (response.message) {
        alert(response.message);
        checkout.setLoadWaiting(false);
    } else {
        $('<?php echo $_code ?>_token').value = response.token_value;


        var request = new Ajax.Request(
             payment.saveUrl,
             {
                 method:'post',
                 onComplete: payment.onComplete,
                 onSuccess: payment.onSave,
                 onFailure: checkout.ajaxFailure.bind(checkout),
                 parameters: Form.serialize(payment.form)
             }
         );
    }
}

Object.extend(Payment.prototype, {
    save: function() {
        if (this.currentMethod == "hps_securesubmit") {
            if (checkout.loadWaiting!=false)
                return;
            var validator = new Validation(this.form);
            if (this.validate() && validator.validate()) {
                checkout.setLoadWaiting('payment');

                hps.tokenize({
                    data: {
                        public_key: '<?php echo $public_key ?>',
                        number: document.getElementById('<?php echo $_code ?>_cc_number').value,
                        cvc: document.getElementById('<?php echo $_code ?>_cc_cid').value,
                        exp_month: document.getElementById('<?php echo $_code ?>_expiration').value,
                        exp_year: document.getElementById('<?php echo $_code ?>_expiration_yr').value
                    },
                    success: function(response) {
                        secureResponseHandler(response);
                    },
                    error: function(response) {
                        secureResponseHandler(response);
                    }
                });
            }
        } else {
            if (checkout.loadWaiting != false)
                return;
            var validator = new Validation(this.form);
            if (this.validate() && validator.validate()) {
                checkout.setLoadWaiting('payment');
                var request = new Ajax.Request(
                    this.saveUrl,
                    {
                        method:'post',
                        onComplete: this.onComplete,
                        onSuccess: this.onSave,
                        onFailure: checkout.ajaxFailure.bind(checkout),
                        parameters: Form.serialize(this.form)
                    }
                );
            }
        }
    }
});
//]]>
</script>
